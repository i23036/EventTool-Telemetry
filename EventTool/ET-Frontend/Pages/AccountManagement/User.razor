@page "/User"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager Navigation

<PageTitle>Nutzerkonto</PageTitle>

<!-- Inhalt -->
<div class="flex-md-column w-100 h-100 p-4">
    <!-- Überschrift -->
    <MudText Typo="Typo.h4">Mitgliedschaften</MudText>

    <!-- Grid -->
    <MudDataGrid T="Mitgliedschaft" Items="@Mitgliedschaften" Dense="true">
        <Columns>

            <!-- Organisation Name -->
            <PropertyColumn Property="x => x.OrganisationName" Title="Organisation" />

            <!-- E-Mail + Speichern (links) -->
            <TemplateColumn Title="E-Mail bearbeiten" CellClass="text-start">
                <CellTemplate Context="ctx">
                    @{
                        var email = ctx.Item.Email ?? "";
                        var atIndex = email.IndexOf('@');
                        var domain = atIndex >= 0 ? email[atIndex..] : "";
                        var id = ctx.Item.OrganisationId;

                        // Initialisieren, wenn nötig
                        if (!EmailLocalParts.ContainsKey(id))
                        {
                            var local = atIndex >= 0 ? email[..atIndex] : email;
                            EmailLocalParts[id] = local;
                        }
                    }

                    <div class="d-inline-flex align-items-center" style="gap: 6px;">
                        <MudTextField @bind-Value="EmailLocalParts[id]"
                                      Dense="true"
                                      Margin="Margin.Dense"
                                      Style="width: 150px;" />
                        <span class="text-muted">@domain</span>
                        <MudButton Size="Size.Small"
                                   Color="Color.Primary"
                                   Variant="Variant.Outlined"
                                   OnClick="@(() => SpeichereEmail(ctx.Item, EmailLocalParts[id], domain))">
                            Speichern
                        </MudButton>
                    </div>
                </CellTemplate>
            </TemplateColumn>

            <!-- Aktionsspalte (rechte Seite) -->
            <TemplateColumn Title="" CellClass="text-end">
                <CellTemplate Context="ctx">
                    <div class="d-inline-flex align-items-center" style="gap: 8px;">
                        <MudButton Color="Color.Error"
                                   Variant="Variant.Filled"
                                   Size="Size.Small"
                                   OnClick="@(() => EntferneMitgliedschaft(ctx.Item))">
                            Entfernen
                        </MudButton>

                        <MudButton Color="Color.Success"
                                   Variant="Variant.Filled"
                                   Size="Size.Small"
                                   OnClick="@(() => WechselnZuOrganisation(ctx.Item))">
                            Öffnen
                        </MudButton>
                    </div>
                </CellTemplate>
            </TemplateColumn>

        </Columns>
    </MudDataGrid>
</div>

@code {
    private List<Mitgliedschaft> Mitgliedschaften = new()
    {
        new Mitgliedschaft { OrganisationName = "BitWorks", Email = "du@bitworks.de", OrganisationId = "bitworks" },
        new Mitgliedschaft { OrganisationName = "CodeLab", Email = "du@codelab.org", OrganisationId = "codelab" }
    };

    // Speichert den LocalPart für jede Mitgliedschaft
    private Dictionary<string, string> EmailLocalParts = new();

    public class Mitgliedschaft
    {
        public string OrganisationName { get; set; }
        public string Email { get; set; }
        public string OrganisationId { get; set; }
    }

    private void SpeichereEmail(Mitgliedschaft eintrag, string localPart, string domain)
    {
        eintrag.Email = $"{localPart}{domain}";
        Console.WriteLine($"Email gespeichert: {eintrag.Email} für {eintrag.OrganisationName}");
    }

    private void EntferneMitgliedschaft(Mitgliedschaft eintrag)
    {
        Mitgliedschaften.Remove(eintrag);
    }

    private void WechselnZuOrganisation(Mitgliedschaft eintrag)
    {
        Navigation.NavigateTo($"/?org={eintrag.OrganisationId}");
    }

    private void changeUserInfo()
    {
        Navigation.NavigateTo("/User/Edit");
    }
}
